
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deep Space: Explorer Build (Heavy Graphics)</title>
  <style>
    :root{
      --bg-deep:#05070d;
      --hud:#e5e7eb;
      --glass:rgba(10,16,30,.65);
      --border:rgba(224,194,159,.22);
      --accent:#20b2ae;
    }
    html,body{ height:100%; margin:0; }
    body{
      background: var(--bg-deep);
      color: var(--hud);
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans";
    }

    /* Static glitter stars atop dark bg for immediate richness */
    .stars, .stars:before, .stars:after{
      content:"";
      position: fixed; inset:0; background: transparent; pointer-events: none; z-index: 0;
    }
    .stars:before{
      box-shadow:
        100px 200px #fff, 300px 40px #fff, 600px 120px #fff, 800px 340px #fff,
        1200px 460px #fff, 150px 520px #fff, 900px 640px #fff, 50px 710px #fff,
        1400px 90px #fff, 1600px 260px #fff, 1800px 700px #fff, 400px 760px #fff,
        5vw 20vh #fff, 30vw 80vh #fff, 70vw 50vh #fff, 90vw 30vh #fff;
      width:2px;height:2px;border-radius:50%;
      filter: drop-shadow(0 0 2px rgba(255,255,255,.6));
    }
    .stars:after{
      box-shadow:
        200px 150px #cfe4ff, 500px 220px #fff, 750px 30px #cfe4ff, 980px 300px #fff,
        1300px 480px #cfe4ff, 50px 600px #fff, 1150px 680px #cfe4ff, 1550px 720px #fff;
      width:2px;height:2px;border-radius:50%;
      filter: drop-shadow(0 0 3px rgba(164, 89, 255, .45));
      opacity:.8;
    }

    #gameCanvas{ position: fixed; inset:0; width:100vw;height:100vh; z-index:1; background: transparent; }

    .hud{
      position: fixed; top:12px; left:12px; right:12px; z-index:2;
      display:flex; justify-content:space-between; align-items:center;
      text-shadow:0 0 8px rgba(0,0,0,.7); pointer-events:none;
    }
    .pill{ background: var(--glass); border:1px solid var(--border); padding:.4rem .9rem; border-radius:999px; pointer-events:auto; font-weight:700; }

    .center-overlay{ position: fixed; inset:0; display:grid; place-items:center; z-index:3;
      background: radial-gradient(1400px 800px at 50% -10%, rgba(32,178,174,.12), transparent 65%); }
    .panel{
      width:min(92vw,640px); background:rgba(10,16,30,.88);
      border:1px solid var(--border); border-radius:24px; padding:1.5rem;
      box-shadow:0 24px 64px rgba(0,0,0,.6), 0 0 30px rgba(32,178,174,.2);
      text-align:center;
    }
    .panel h1{ margin:.2rem 0 0.6rem; font-size:1.7rem; }
    .btn{ appearance:none;border:0; padding:.75rem 1.2rem; border-radius:999px;
      background: var(--accent); color:#0a101e; font-weight:800; transition: transform .08s ease, filter .2s ease; }
    .btn:hover{ filter:brightness(1.1); }
    .btn:active{ transform: translateY(1px); }
    .help{ position:fixed; right:14px; bottom:14px; z-index:2; font-size:.9rem;
      background:var(--glass); border:1px solid var(--border); border-radius:12px; padding:.4rem .6rem; opacity:.9; pointer-events:none; }
  </style>
</head>
<body>
  <div class="stars"></div>

  <div class="hud">
    <div class="pill">Discoveries: <span id="discoveries">0</span></div>
    <div class="pill">Hull: <span id="lives">3</span></div>
    <div class="pill">Sector: <span id="sector">Orion</span></div>
  </div>

  <div class="help">Move: A/D/←/→ • Shoot: Space • Scan: E • Shield: Shift • Pause: P</div>
  <canvas id="gameCanvas"></canvas>

  <div class="center-overlay" id="startOverlay">
    <div class="panel">
      <h1>Deep Space: Explorer (Heavy Graphics)</h1>
      <p>Explore nebulae, galaxies, black holes, comet trails and ancient stations. Battles are rare encounters; your mission is discovery.</p>
      <button class="btn" id="btnStart">Launch</button>
    </div>
  </div>
  <div class="center-overlay" id="gameOverOverlay" style="display:none;">
    <div class="panel">
      <h1>Hull Breach</h1>
      <p>Discoveries Logged: <strong id="finalDisc">0</strong></p>
      <button class="btn" id="btnAgain">Go Again</button>
    </div>
  </div>

  <script>
    // ===== Canvas =====
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let W = canvas.width = window.innerWidth;
    let H = canvas.height = window.innerHeight;
    window.addEventListener('resize', () => {
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
    });

    // ===== HUD / Overlays =====
    const discEl = document.getElementById('discoveries');
    const livesEl = document.getElementById('lives');
    const sectorEl = document.getElementById('sector');
    const startOverlay = document.getElementById('startOverlay');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const finalDiscEl = document.getElementById('finalDisc');
    const btnStart = document.getElementById('btnStart');
    const btnAgain = document.getElementById('btnAgain');

    const SECTORS = [
      { name:'Orion', tint:'rgba(32,178,174,0.10)' },
      { name:'Andromeda', tint:'rgba(164,89,255,0.10)' },
      { name:'Triangulum', tint:'rgba(224,194,159,0.08)' },
      { name:'Centaurus A', tint:'rgba(96,165,250,0.10)' },
    ];
    let sectorIndex = 0;

    // ===== Game State =====
    let running = false, paused = false, frame = 0;
    const keys = {};
    window.addEventListener('keydown', (e) => {
      if(e.code==='Space') e.preventDefault();
      keys[e.code]=true;
      if(e.code==='KeyP') paused=!paused;
    });
    window.addEventListener('keyup', (e) => keys[e.code]=false);

    // Player ship
    const player = {
      x: 0, y: 0, size: 34,
      speed: 5.5, lives: 3, cooldown: 0,
      shield: 0, shieldCd: 0, scans: 0
    };

    // Entities / background
    let bullets = [], enemies = [], enemyBullets = [], particles = [];
    let stars = [], starFlares = [], planets = [], galaxies = [], nebulas = [], blackHoles = [], neutronStars = [], dmFields = [], comets = [], astBelts = [], stations = [];
    let discoveries = 0, encounterTimer = 900; // 15s at 60fps

    // Helpers
    function rand(a,b){ return a + Math.random()*(b-a); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function rectsOverlap(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
    function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }

    // === Generators ===
    function generateStars(){
      stars = [];
      const layers = [
        { n: 380, speed: 0.35, size: 1, alpha: 0.6 },
        { n: 260, speed: 0.65, size: 1.5, alpha: 0.9 },
        { n: 180, speed: 1.0, size: 2, alpha: 1.0 }
      ];
      layers.forEach(L => {
        for(let i=0;i<L.n;i++){
          stars.push({ x: Math.random()*W, y: Math.random()*H, s: L.size, v: L.speed, a: L.alpha });
        }
      });
      // occasional big flares
      starFlares = [];
      for(let i=0;i<4;i++){
        starFlares.push({ x: rand(0, W), y: rand(-H, 0), vy: rand(.08,.18), r: rand(50, 120), t: Math.random()*1000 });
      }
    }
    function generatePlanets(){ planets = []; for(let i=0;i<5;i++){ planets.push({ x: rand(80, W-80), y: rand(-H, -80), r: rand(40, 160), vy: rand(0.18, 0.55), hue: Math.floor(rand(180,360)) }); } }
    function generateGalaxies(){ galaxies = []; for(let i=0;i<3;i++){ galaxies.push({ x: rand(100, W-100), y: rand(-H, -200), r: rand(220, 320), vy: rand(.04,.12), rot: rand(0, Math.PI*2) }); } }
    function generateNebulas(){ nebulas = []; for(let i=0;i<3;i++){ nebulas.push({ x: rand(80, W-80), y: rand(-H, -200), w: rand(320, 520), h: rand(200, 320), vy: rand(.08,.2), hue: Math.floor(rand(200,330)), alpha: .2 }); } }
    function generateBlackHoles(){ blackHoles = []; for(let i=0;i<1;i++){ blackHoles.push({ x: rand(120, W-120), y: rand(-H, -200), mass: rand(7000, 11000), vy: rand(.10,.2) }); } }
    function generateNeutronStars(){ neutronStars = []; for(let i=0;i<1;i++){ neutronStars.push({ x: rand(80, W-80), y: rand(-H, -200), vy: rand(.12,.22), pulse: 0 }); } }
    function generateDarkMatter(){ dmFields = []; for(let i=0;i<2;i++){ dmFields.push({ x: rand(80, W-80), y: rand(-H, -200), r: rand(140, 260), vy: rand(.08,.18), t: Math.random()*1000 }); } }
    function generateComets(){ comets = []; for(let i=0;i<2;i++){ comets.push({ x: rand(50, W-50), y: rand(-H, -200), vy: rand(.35,.55), vx: rand(-.2,.2), len: rand(80,140), t: 0 }); } }
    function generateAstBelts(){ astBelts = []; for(let i=0;i<2;i++){ astBelts.push({ y: rand(-H, -200), vy: rand(.2,.35), rocks: Array.from({length: 40}, _=>({ x: rand(0,W), r: rand(2,5) })) }); } }
    function generateStations(){ stations = []; for(let i=0;i<2;i++){ stations.push({ x: rand(120,W-120), y: rand(-H,-200), vy: rand(.12,.2), scanned: false }); } }

    // ===== Encounters (rare) =====
    function spawnEncounter(){
      // very small formation
      const cols = 3 + Math.floor(rand(0,2));
      const rows = 1 + Math.floor(rand(0,2));
      const gapX = (W - 200) / cols;
      const startY = -50;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          enemies.push({
            x: 100 + c*gapX, y: startY - r*42,
            w: 28, h: 28,
            vx: Math.sin((r*cols+c)*0.7) * 0.5,
            vy: 1.4,
            hp: 1 + (Math.random()<0.15?1:0),
            cd: rand(70,140)
          });
        }
      }
    }

    function hyperspaceJump(){
      sectorIndex = (sectorIndex + 1) % SECTORS.length;
      sectorEl.textContent = SECTORS[sectorIndex].name;
      addExplosion(W/2, H*0.25, 'rgba(32,178,174,1)');
      generatePlanets(); generateGalaxies(); generateNebulas();
      generateBlackHoles(); generateNeutronStars(); generateDarkMatter();
      generateComets(); generateAstBelts(); generateStations();
    }

    // ===== Effects =====
    function addExplosion(x,y,color='rgba(255,255,255,1)'){
      for(let i=0;i<32;i++){
        particles.push({ x, y, vx: rand(-3,3), vy: rand(-3,3), life: rand(22,44), color });
      }
    }
    function addThruster(x,y){
      particles.push({ x, y, vx: rand(-1,1), vy: rand(2,5), life: rand(10,16), color:'rgba(96,165,250,1)' });
      particles.push({ x: x+3, y, vx: rand(-1,1), vy: rand(2,5), life: rand(10,16), color:'rgba(32,178,174,1)' });
    }

    // ===== Rendering helpers =====
    function drawBackground(){
      ctx.fillStyle = '#05070d'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle = SECTORS[sectorIndex].tint; ctx.fillRect(0,0,W,H);

      // stars
      stars.forEach(s => {
        s.y += s.v;
        if(s.y > H){ s.y = -4; s.x = Math.random()*W; }
        ctx.globalAlpha = s.a; ctx.fillStyle = '#ffffff'; ctx.fillRect(s.x, s.y, s.s, s.s); ctx.globalAlpha = 1;
      });
      // star flares
      starFlares.forEach(f => {
        f.y += f.vy; f.t += 0.01;
        if(f.y - f.r > H+60){ f.y = -f.r-60; f.x = rand(0,W); }
        const grad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.r);
        grad.addColorStop(0, 'rgba(255,255,255,0.35)');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.globalAlpha = 0.25 + 0.1*Math.sin(f.t);
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
      });

      // galaxies
      galaxies.forEach(g => {
        g.y += g.vy; g.rot += 0.0006;
        if(g.y - g.r > H+80){ g.y = -g.r-80; g.x = rand(100, W-100); }
        const grad = ctx.createRadialGradient(g.x, g.y, 0, g.x, g.y, g.r);
        grad.addColorStop(0, 'rgba(255,255,255,0.8)');
        grad.addColorStop(1, 'rgba(255,255,255,0.0)');
        ctx.save(); ctx.globalAlpha = 0.22; ctx.translate(g.x, g.y); ctx.rotate(g.rot);
        ctx.fillStyle = grad; ctx.beginPath(); ctx.ellipse(0,0, g.r, g.r*0.55, 0, 0, Math.PI*2); ctx.fill();
        ctx.restore();
      });

      // nebulas
      nebulas.forEach(n => {
        n.y += n.vy;
        if(n.y - n.h/2 > H+100){ n.y = -n.h-100; n.x = rand(80, W-80); }
        const grad = ctx.createRadialGradient(n.x, n.y, 10, n.x, n.y, Math.max(n.w,n.h));
        grad.addColorStop(0, `hsla(${n.hue},70%,70%,${n.alpha})`);
        grad.addColorStop(1, `hsla(${n.hue},60%,30%,0)`);
        ctx.fillStyle = grad; ctx.fillRect(n.x - n.w, n.y - n.h, n.w*2, n.h*2);
      });

      // planets
      planets.forEach(p => {
        p.y += p.vy;
        if(p.y - p.r > H + 60){ p.y = -p.r - 60; p.x = rand(80, W-80); }
        const grad = ctx.createRadialGradient(p.x - p.r*.4, p.y - p.r*.4, p.r*.2, p.x, p.y, p.r);
        grad.addColorStop(0, `hsla(${p.hue},70%,70%,0.9)`);
        grad.addColorStop(1, `hsla(${p.hue},50%,30%,0.18)`);
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        if(p.r>70){ ctx.strokeStyle='rgba(224,194,159,0.45)'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(p.x, p.y, p.r*1.2, p.r*0.35, 0.3, 0, Math.PI*2); ctx.stroke(); }
      });

      // comet trails
      comets.forEach(c => {
        c.y += c.vy; c.x += c.vx; c.t += 1;
        if(c.y > H+80){ c.y = -80; c.x = rand(50,W-50); }
        // head
        ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(c.x, c.y, 3, 0, Math.PI*2); ctx.fill();
        // tail
        const tail = ctx.createLinearGradient(c.x, c.y, c.x, c.y + c.len);
        tail.addColorStop(0, 'rgba(173,216,230,0.9)'); tail.addColorStop(1, 'rgba(173,216,230,0)');
        ctx.strokeStyle = tail; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(c.x, c.y + c.len); ctx.stroke();
      });

      // asteroid belts
      astBelts.forEach(b => {
        b.y += b.vy;
        if(b.y > H+20){ b.y = -20; b.rocks.forEach(r => r.x = rand(0,W)); }
        ctx.fillStyle = 'rgba(148,163,184,0.8)';
        b.rocks.forEach(r => ctx.fillRect(r.x, b.y + Math.sin((r.x+b.y)*0.01)*3, r.r, r.r));
      });

      // stations
      stations.forEach(s => {
        s.y += s.vy;
        if(s.y > H+120){ s.y = -120; s.x = rand(120, W-120); s.scanned=false; }
        // body
        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.fillStyle = 'rgba(200,210,220,0.9)';
        ctx.fillRect(-16, -8, 32, 16);
        ctx.fillRect(-6, -20, 12, 12);
        ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.strokeRect(-16, -8, 32, 16);
        // solar panels
        ctx.fillStyle = 'rgba(64,178,174,0.8)';
        ctx.fillRect(-42, -6, 26, 12);
        ctx.fillRect(16, -6, 26, 12);
        ctx.restore();
      });

      // dark matter fields
      dmFields.forEach(f => {
        f.y += f.vy; f.t += 0.01;
        if(f.y - f.r > H+60){ f.y = -f.r-60; f.x = rand(80, W-80); }
        ctx.save(); ctx.globalAlpha = 0.08 + 0.04*Math.sin(f.t);
        ctx.strokeStyle = '#7dd3fc'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.stroke(); ctx.restore();
      });

      // black holes
      blackHoles.forEach(bh => {
        bh.y += bh.vy;
        if(bh.y > H + 120){ bh.y = -120; bh.x = rand(120, W-120); }
        const r = 34;
        const grad = ctx.createRadialGradient(bh.x, bh.y, 5, bh.x, bh.y, 80);
        grad.addColorStop(0, 'rgba(0,0,0,1)'); grad.addColorStop(0.5, 'rgba(0,0,0,1)');
        grad.addColorStop(0.7, 'rgba(255,140,0,0.3)'); grad.addColorStop(1, 'rgba(255,220,150,0.05)');
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(bh.x, bh.y, 80, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(bh.x, bh.y, r, 0, Math.PI*2); ctx.fill();
      });

      // neutron stars
      neutronStars.forEach(ns => {
        ns.y += ns.vy; ns.pulse = (ns.pulse + 3) % 600;
        if(ns.y > H + 120){ ns.y = -120; ns.x = rand(80, W-80); ns.pulse = 0; }
        ctx.fillStyle = 'rgba(200,220,255,0.9)'; ctx.beginPath(); ctx.arc(ns.x, ns.y, 6, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'rgba(200,220,255,0.22)'; ctx.lineWidth = 2; ctx.beginPath();
        ctx.arc(ns.x, ns.y, 20 + ns.pulse*0.35, 0, Math.PI*2); ctx.stroke();
      });
    }

    // Player ship rendering (detailed)
    function drawPlayerShip(x,y,scale=34){
      ctx.save(); ctx.translate(x,y);

      // shadow
      ctx.globalAlpha = 0.25; ctx.fillStyle = '#000';
      ctx.beginPath(); ctx.ellipse(0, scale*0.55, scale*0.7, scale*0.35, 0, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;

      // wings
      const wingGrad = ctx.createLinearGradient(-scale, 0, scale, 0);
      wingGrad.addColorStop(0, '#64748b'); wingGrad.addColorStop(1, '#94a3b8');
      ctx.fillStyle = wingGrad;
      ctx.beginPath();
      ctx.moveTo(-scale*0.95, scale*0.42);
      ctx.lineTo(-scale*0.2, -scale*0.1);
      ctx.lineTo(scale*0.2, -scale*0.1);
      ctx.lineTo(scale*0.95, scale*0.42);
      ctx.lineTo(0, scale*0.7);
      ctx.closePath();
      ctx.fill();

      // hull
      const hullGrad = ctx.createLinearGradient(0, -scale*0.6, 0, scale*0.7);
      hullGrad.addColorStop(0, '#e2e8f0'); hullGrad.addColorStop(1, '#94a3b8');
      ctx.fillStyle = hullGrad; ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, -scale*0.9);
      ctx.lineTo(-scale*0.25, -scale*0.2);
      ctx.lineTo(-scale*0.18, scale*0.6);
      ctx.lineTo(scale*0.18, scale*0.6);
      ctx.lineTo(scale*0.25, -scale*0.2);
      ctx.closePath();
      ctx.fill(); ctx.stroke();

      // cockpit
      ctx.fillStyle = 'rgba(96,165,250,0.95)';
      ctx.beginPath(); ctx.ellipse(0, -scale*0.25, scale*0.22, scale*0.16, 0, 0, Math.PI*2); ctx.fill();

      // engine glow
      const glow = ctx.createRadialGradient(0, scale*0.6, 2, 0, scale*0.8, scale*0.6);
      glow.addColorStop(0, 'rgba(32,178,174,0.9)'); glow.addColorStop(1, 'rgba(32,178,174,0)');
      ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(0, scale*0.75, scale*0.55, 0, Math.PI*2); ctx.fill();

      ctx.restore();
    }
    function drawEnemyShip(x,y,size=26){
      ctx.save(); ctx.translate(x,y);
      ctx.fillStyle = '#f472b6';
      ctx.beginPath(); ctx.moveTo(0, size); ctx.lineTo(-size*0.6, 0); ctx.lineTo(size*0.6, 0); ctx.closePath(); ctx.fill();
      ctx.fillStyle = 'rgba(251,113,133,0.9)'; ctx.beginPath(); ctx.arc(0, size*0.4, size*0.16, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // ===== Reset/Start/End =====
    function reset(){
      discoveries = 0; discEl.textContent = discoveries;
      player.x = W/2; player.y = H-90; player.lives = 3; livesEl.textContent = player.lives;
      player.cooldown = 0; player.shield = 0; player.shieldCd = 0; encounterTimer = 900;
      bullets = []; enemies = []; enemyBullets = []; particles = [];
      sectorIndex = 0; sectorEl.textContent = SECTORS[0].name; frame = 0;
      generateStars(); generatePlanets(); generateGalaxies(); generateNebulas();
      generateBlackHoles(); generateNeutronStars(); generateDarkMatter();
      generateComets(); generateAstBelts(); generateStations();
    }
    function startGame(){ reset(); startOverlay.style.display='none'; gameOverOverlay.style.display='none'; running=true; paused=false; }
    function endGame(){ running=false; finalDiscEl.textContent = discoveries; setTimeout(()=> gameOverOverlay.style.display='grid', 350); }

    // ===== Update =====
    function update(){
      if(!running || paused) return;
      frame++;

      // input
      const left = keys['ArrowLeft'] || keys['KeyA'];
      const right = keys['ArrowRight'] || keys['KeyD'];
      const up = keys['ArrowUp'] || keys['KeyW'];
      const down = keys['ArrowDown'] || keys['KeyS'];
      const vx = (right?1:0) - (left?1:0);
      const vy = (down?1:0) - (up?1:0);
      player.x += vx * player.speed;
      player.y += vy * (player.speed * 0.9);
      player.x = clamp(player.x, 30, W-30);
      player.y = clamp(player.y, H-150, H-30);

      // shield
      if(keys['ShiftLeft'] || keys['ShiftRight']){
        if(player.shieldCd<=0){ player.shield = 14; player.shieldCd = 140; addExplosion(player.x, player.y, 'rgba(32,178,174,1)'); }
      }
      if(player.shieldCd>0) player.shieldCd--;
      if(player.shield>0) player.shield--;

      // shooting (optional, but slow cadence)
      if(player.cooldown>0) player.cooldown--;
      if(keys['Space'] && player.cooldown===0){
        bullets.push({ x: player.x-6, y: player.y-18, w: 6, h: 16, vy: -11 });
        bullets.push({ x: player.x+6, y: player.y-18, w: 6, h: 16, vy: -11 });
        player.cooldown = 10;
      }

      // scan key: log a discovery if near a feature
      if(keys['KeyE']){
        // proximity checks
        const nearby = [];
        planets.forEach(p => { if(dist(player.x,player.y,p.x,p.y) < p.r+80) nearby.push('Planet'); });
        stations.forEach(s => { if(dist(player.x,player.y,s.x,s.y) < 120 && !s.scanned){ s.scanned=true; nearby.push('Derelict Station'); } });
        galaxies.forEach(g => { if(dist(player.x,player.y,g.x,g.y) < g.r*0.8) nearby.push('Galaxy'); });
        nebulas.forEach(n => { if(dist(player.x,player.y,n.x,n.y) < Math.max(n.w,n.h)*0.6) nearby.push('Nebula'); });
        blackHoles.forEach(bh => { if(dist(player.x,player.y,bh.x,bh.y) < 120) nearby.push('Black Hole'); });
        neutronStars.forEach(ns => { if(dist(player.x,player.y,ns.x,ns.y) < 120) nearby.push('Neutron Star'); });
        if(nearby.length){
          discoveries += nearby.length;
          discEl.textContent = discoveries;
        }
      }

      // thruster
      if(frame%2===0) addThruster(player.x, player.y + 20);

      // gravity & fields
      blackHoles.forEach(bh => {
        const d = dist(player.x, player.y, bh.x, bh.y);
        const g = bh.mass / Math.max(1500, d*d);
        const ang = Math.atan2(bh.y - player.y, bh.x - player.x);
        player.x += Math.cos(ang)*g; player.y += Math.sin(ang)*g;
        bullets.forEach(bl => {
          const dd = dist(bl.x, bl.y, bh.x, bh.y);
          const gg = bh.mass / Math.max(1600, dd*dd);
          const a2 = Math.atan2(bh.y - bl.y, bh.x - bl.x);
          bl.x += Math.cos(a2)*gg*4; bl.y += Math.sin(a2)*gg*4;
        });
      });
      neutronStars.forEach(ns => {
        const r = 20 + ns.pulse*0.35;
        const d = dist(player.x, player.y, ns.x, ns.y);
        if(d < r + 30){ const ang = Math.atan2(player.y - ns.y, player.x - ns.x); player.x += Math.cos(ang)*0.6; player.y += Math.sin(ang)*0.6; }
      });
      dmFields.forEach(f => { const d = dist(player.x, player.y, f.x, f.y); if(d < f.r){ const jitter = (1 - d/f.r) * 0.6; player.x += (Math.random()-0.5)*jitter; } });

      // bullets
      bullets.forEach(b => b.y += b.vy);
      bullets = bullets.filter(b => b.y > -40);

      // encounters: only sometimes
      encounterTimer--;
      if(encounterTimer<=0 && enemies.length===0){
        spawnEncounter();
        encounterTimer = 900 + Math.floor(rand(-240, 240)); // ~15s ± 4s
      }

      // enemy logic (small groups)
      enemies.forEach(e => {
        e.y += e.vy; e.x += e.vx; e.cd--;
        if(e.cd<=0 && Math.random()<.05){
          enemyBullets.push({ x: e.x, y: e.y + e.h*0.6, w:6, h:14, vy: 5.5 });
          e.cd = rand(90, 160);
        }
      });
      enemies = enemies.filter(e => {
        if(e.y - e.h/2 > H){ return false; } // let them pass without heavy penalty
        return e.hp>0;
      });

      // enemy bullets
      enemyBullets.forEach(b => b.y += b.vy);
      enemyBullets = enemyBullets.filter(b => b.y < H + 40);

      // collisions
      bullets.forEach(b => {
        enemies.forEach(e => {
          if(rectsOverlap({x:b.x-3,y:b.y,w:b.w,h:b.h},{x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
            e.hp -= 1; b.y = -999;
            if(e.hp<=0){ addExplosion(e.x, e.y); e.y = H + 999; discoveries += 1; discEl.textContent = discoveries; } // reward: log as discovery
          }
        });
      });
      enemies = enemies.filter(e => e.y < H + 900 && e.hp>0);

      for(let i=0;i<enemyBullets.length;i++){
        const b = enemyBullets[i];
        if(rectsOverlap({x:b.x-3,y:b.y,w:b.w,h:b.h},{x:player.x-18,y:player.y-24,w:36,h:48})){
          if(player.shield===0){
            b.y = H + 999; addExplosion(player.x, player.y, 'rgba(255,100,100,1)');
            player.lives--; livesEl.textContent = player.lives; if(player.lives<=0) return endGame();
          } else { b.y = H + 999; }
        }
      }
      enemyBullets = enemyBullets.filter(b => b.y < H + 800);

      // hyperspace to refresh scenery every few discoveries
      if(discoveries>0 && discoveries % 12 === 0 && frame % 60 === 0){ hyperspaceJump(); }
    }

    // ===== Draw =====
    function draw(){
      if(!running) return;
      drawBackground();

      // player
      drawPlayerShip(player.x, player.y, player.size);
      if(player.shield>0){ ctx.save(); ctx.strokeStyle='rgba(32,178,174,0.7)'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(player.x, player.y, 36, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }

      // bullets
      ctx.fillStyle = '#a4b1ff'; bullets.forEach(b => ctx.fillRect(b.x-3,b.y,b.w,b.h));

      // enemies & bullets
      enemies.forEach(e => drawEnemyShip(e.x, e.y, e.w));
      ctx.fillStyle = '#f87171'; enemyBullets.forEach(b => ctx.fillRect(b.x-3, b.y, b.w, b.h));

      // particles
      particles.forEach(p => { ctx.fillStyle = p.color.replace(',1)', ',' + (p.life/44).toFixed(2) + ')'); ctx.fillRect(p.x, p.y, 3, 3); });
    }

    function loop(){ if(running && !paused) update(); draw(); requestAnimationFrame(loop); }
    btnStart.addEventListener('click', startGame);
    btnAgain.addEventListener('click', startGame);
    reset(); loop();
  </script>
</body>
</html>
